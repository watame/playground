# イベントURL
- https://rakus.connpass.com/event/326973/

## SPFって2つあるんですよ
- SPF単体ではなりすましに気付けない
  - SPFはエンベロープのfromと照会するので、なりすましてもOK
  - ヘッダのfromを用いて認証するのは Sender-ID なので、Sender-IDを利用しよう

### SPFとSender-ID
- SPFだけでは不正防止効果は限定的なので、DKIM, DMARC とセットで利用する
- Sender-id を見ているISPもあるので、信頼性向上の観点から対応が必要
- 自社のSMTPサーバだとエンベロープとヘッダで一致するが、配信ツールを利用しているとエンベロープとヘッダのドメインが分かれることも
  - エンベロープ（配信ツール）
  - ヘッダ（自社ドメイン）
- DMARCの検証はSPFがチェックされているので、Sender-IDは関係なし

## DKIM
電子署名を用いてメールの正当性を検証する認証手法
- 送信者：秘密鍵で署名
- 受信者：公開鍵で署名を検証

受信サーバーはDNSサーバーにある公開鍵を確認する

### 検証の仕組み
1. 公開鍵で署名を復号してハッシュ値を入手
2. 受信メールの内容をハッシュ化して値を入手
3. 1,2が同じだったら認証OK

キー事態が改ざんされている場合、1の復号化ができない
内容が改ざんされている場合、3の突合で失敗する

### 実際の署名
d=example.com <- DKIMのドメイン
h=xxxx:From:xxxx

From:example.comであれば、作成者署名
From:がexample.comでなければ、第三者署名

第三者署名は信頼性が低い
-> ヘッダfromと異なるDKIMに署名できるので、なりすまし可能

ヘッダfrom: ok.com
エンベロープfrom: ng.com
DKIM: ng.com
-> DKIM署名されたメール送信できる


## DMARC
SPFとDKIMの検証結果に基づいて、メール受信者が不正なメールをどのように処理すべきかドメイン所有者が指示できる
- 何もしない
- 隔離する（迷惑メールボックスに入れてもらう）
- 拒否する

### 認証プロセス
- SPF, DKIMの双方の認証が成功、かつ、どちらかのアライメントが取れていたら成功となる
  - DMARCアライメントとはヘッダfromのドメインと認証に使われたドメインが一致しているか、ということ
  - 実質、第三者署名はDMARCでは設定できない
- 一般的に3rdPartyのメール配信ツールなどを利用する際は、DKIMの秘密鍵をツール側に登録して配信ツール側で作成者署名をする
  - DKIMであアライメントを取ることができる

### DMARCで失敗しないために
サブドメインを区切り、表で管理することで明確に管理することが重要

## メール認証の発展型
### DMARCのポリシー引き上げ
なりすましを防ぐ目的であれば、少なくとも最終ゴールとしてrejectを目指していく必要がある
到達率の観点でもなりすましが減っていくと迷惑メール報告の減少などで、ドメインIPの信頼性、評判が高くなっていく
※ p=reject にいきなりするとキツイ感じする

すでに運用している環境にDMARCをp=rejectで設定すると、意図しないメール送信失敗が発生する可能性あり
下記のように段階的引き上げが良い
1. noneを設定
2. DMARCが失敗しているものを確認して対処
   1. FAILとなっているメールを確認
   2. 組織内からメールが届いていないという報告を受けられるよう窓口を設置
3. 一定期間運用して　意図しないFAILがあ発生していないか確認
4. ある程度網羅的にDMARCがPASSとなっていると判断でkチアタイミングで quarantine に引き上げ
5. 同様の対応をして、更に網羅的にPASSしていることを確認できたら reject に引き上げ

### 意図しないDMARCの失敗リスクを下げるには
複数サービスを展開している場合、グループ会社などでドメインを共有している場合、網羅的にDMARCを成功させるには、管理含めてかなり工数がかかる
なりすましメールが発生していると、正規のメールだけどDMARCが失敗しているもの、なりすましメールが混ざってレポートに上がるのでややこしい

対応は下記
- 主要なものからサブドメイン化し、切り出して reject を適用していく
  - 信頼性を上げて到達率を担保したいメールに付与

### BIMI
ドメインの認証は重要だが、メールボックス内では表示名が押し出されている
-> 表示名はドメイン認証の対象外なので、大手企業を名乗るメールでよく見てみるとなりすましメールになっているケースがある

ロゴを表示するなどの消費者に良い影響を与えることもできる
-> クレカ会社などではよくやっているらしい
