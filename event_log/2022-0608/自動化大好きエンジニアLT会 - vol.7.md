# チームで始める テスト文化のすすめ ~テスト自動化のその先へ~
発表者：@naoki-haba

## テスト作業の自動化
- 自動化前
  - Postmanで人力チェック
  - 自動化のモチベーション
    - クリティカルな機能は自動で毎回チェックしたい
    - QAが居ないので、試験工程の負担を減らしたい
- 自動化後
  - GitHubActionsで自動テスト
    - 1. PR to main
    - 2. GitHubActionsで自動テスト

## 自動化の恩恵
- デグレの検知が出来た
- 時間がかかるテスト項目の負担軽減

## まとめ
自動化は素晴らしい取り組みだが、アンチパターンもある
- 自分1人で導入する
  - 誰も保守できない
- チームで共有しないと負の遺産になる
  - チーム全体がテストって良いねと思えるようにするのが大事

## QA
- カバレージはどうしている？
  - 追いすぎないよ言うにしている
  - 

# Seleniumでイキってたら、サーバを締め落としかけてた話
発表者：

## なにをしたか
- 手作業を自動化した
- Seleniumで自動化できた
- いけたとおもったらサーバのリソースを食いつぶしていた

## 自動化した内容
- メンテ情報をカレンダーに登録する作業
  - 手動で内容をコピペしていたのを改善した

### 自動化フロー
- フォームを受け取って、Seleniumで自動的にカレンダー登録

## エラーが出てる
- `Too many open files`は出続ける
- スクリプト自体は正常に動作する

-> クロームのブラウザが山盛り開かれていた

### 原因
例外処理ができておらず、エラーが発生したときには`quit()`が呼ばれていない

## 教訓
- プロセスのエラーが出た場合は、`ps`等で調査を進めるべき
- 例外処理は最初に行うようにしよう

## QA
- mallocの現代版っぽいね
  - 便利になったからこそ発生した問題かも

# ちょっと便利になる自動補完とAnsibleでのパッケージ管理について
発表者：Bunta Fujikawa

## ツールの話
### peco × anyframe
コマンドのインクリメンタルサーチが出来る
`history | grep hogehoge`をやらなくてOKなので楽

### fig
bash, zshなどの自動化ツール
-> ディレクトリの次のディレクトリ出してくれたりする
    `npm run` まで入れるとパッケージ出してくれる
すごい効率よくなるけど、環境構築が辛くなる

### Ansibleでローカルパッケージの管理
- git clone / brew install / npm install 等をインストールできる
- GUIアプリのインストールも `brew install`で出来る
- やっていること
  - パッケージをyamlで管理

コマンド一発で設定が出来る
- エラーになっているとそこがキャッチアップになるので良い

# Ansibleの実行速度を1/3にした話
発表者：いじまけん

## 背景
サービスを支えるサーバーのAnsible構成管理かが進んだが、、、

- 台数増加
- 構成管理範囲の増加
- Ansible実行回数が増加

Ansibleの実行時間の長時間化が問題に

## Ansible実行時間の把握
- 重要時間なのは**時間がかかっている処理がどの処理**か
- CallBackで処理時間が把握できる
  - ボトルネックの把握

## インストールパッケージの見直し
パッケージのインストール処理は**パッケージ名を配列**で渡すことで、ループしなくてもすむようになる

## パッケージリポジトリ環境
パッケージ操作では
- リポジトリ参照
- パッケージのダウンロードが毎回行われる

改善
- ミラーリポジトリをホストの近くに設置
- パッケージをあらかじめ同梱したOSを配布

## 実行環境改善
- Pipeliningの有効化
- Mitogen for Ansible
- FORK数の変更

### Mitogenの特徴
- 実行コードのRAMキャッシュ
- pipelineと同様ターゲットへの書き込み削減
- Thread化によるさらなる並列化
- ネットワークコネクションの再利用

# Gitla CIでMRを自動生成する
発表者：Taku Hatano

## Gitlab CIとは
- Gitlabが提供するCI/CDを自動化するための仕組み

## ブランチ戦略
- GitFlow
  - 開発ブランチ
  - MR提出
  - レビュー完了後マージ

MR作るのが面倒

## GitLabCIの設定
- APIを使用
  - MR作成済みかチェック -> 無ければMRを作成
  - GitLabCIが提供する環境変数を埋め込める

## 良かった点
- 思った以上に快適
- MR作成漏れが防げる
- MRのフォーマットを統一しやすい
  - テンプレートを用意しても使われなければ意味ない

## QA
- レビュワーの自動アサイン
  - プロジェクト毎にランダムに1人選ばれる

# TerraformのPlanとApplyの自動化
発表者：Kohei Yamamoto

## Terraformとは何か
- インフラリソースをコードで管理するツール
- Planコマンド
  - インフラの変更差分を表示
- Applyコマンド
  - インフラの変更差分を適用
- CodeBuildを利用してTerraform Plan/Applyを組み込んでいる

## Terraform Plan/Apply結果をどう通知しているか
- Plan
  - GitHubのPR時にPlanの結果を通知している
- Apply
  - Slackで成否を通知

## 結果通知
### 導入した経緯
- PR時のPlanの確認
  - AWSの画面でチェックする必要あり
### 導入後
- terraformをGitHubActionで利用して、実行までテストできる

### Plan通知
- OSSツールで実行
  - tfnotify

### Apply通知の詳細
- EventBridgeとLambdaで実装
  - CodeBuildの実行結果イベントでLambda発火

## まとめ
- PlanをGitHubコメントとして投稿することでTerraform開発体験が飛躍的に良くなった
- PRをマージしたのちにGitHubに訪問することがなくなった

## QA
- terraform applyの自動化は危険そうに思えるが困っていることはないか？
  - 複数人の目を通せるので、特に困ったことはない

# Airflowはすごいぞ！
発表者：Hank Ehly

## AirFlowとは
- ワークフローを作成、実行監視するためのプラットフォーム
- Python製
- Airbnb、メルカリ、楽天、Tesla、Twitter等が利用している
  - マネージド版
    - AWS
    - GCP
    - Astronomer

### 解決する問題
ワークフローの開発において様々な課題がある
1. タスクの依存関係を明確にする
   - 通常：ドキュメントやコメント
   - エアフロー：タスクがフローチャートとして表示される
2. エラーが起きた箇所を特定する
   1. 通常：追跡可能なログを出力する
   2. エアフロー：エラー表示のタスクをクリックしてログを確認 
3. タスクを同時に実行する
   1. multiprocessing, asyncioで頑張る
   2. 依存関係がない場合は同時に実行される
4. 失敗しがちな処理を3回までリトライする
   1. リトライ用のデコレーター関数を利用
   2. タスクの「最大リトライ数」を設定する

### コンセプト
- DAGs
  - Directed Acyclic Graph
  - 依存関係にあるタスクを「どの順番で実行する」か
- Tasks
  - DAGを構成する要素
  - Python関数、Rubyコンテナ、Bashスクリプト等
    - それぞれ「状態」を持つ
- Operators
  - タスクのテンプレート
  - 用意されているモノがたくさんある
    - コミュニティに用意されているものがたくさんある
- Variables
  - KeyValueStore

## ブログ記事
- https://qiita.com/hankehly/items/1f02a34740276d1b8f0f

# dev.toの記事もGitHubで管理してみた
発表者：森祐太朗(@Y0u281)

## 背景
- Zennでブログ執筆中
  - GitHub ActionsでZennブログの校正が自動化できる
- deb.toでも同じように自動投稿を実現したい
  - 既に実践している人が居たので参考にしてみた

## dev.to
- 英語版Qiita

## GitHubActionで利用するうには
- Dev.toのAPIキーを設定する
- draft記事を作る
  - めんどくさいのでAPI経由で作るのが良い
- draft記事のIDを取得する
- IDを設定する
- GitHubでPRを作成
  - GitHubActionで誤字脱字のチェック
- PRをマージしたら記事が投稿される
